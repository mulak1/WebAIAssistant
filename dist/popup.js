import{i as g,d as u}from"./cryptoUtils.js";let i="";document.addEventListener("DOMContentLoaded",async()=>{await g();const h=document.getElementById("sendBtn"),l=document.getElementById("userInput"),a=document.getElementById("chatBox"),m=document.getElementById("clearHistoryBtn");chrome.storage.local.get(["encryptedApiKey","iv","personality"],async t=>{if(t.encryptedApiKey&&t.iv)try{i=await u(t.encryptedApiKey,t.iv)}catch{n("assistant","❌ Failed to load your API key. Please re-save it in settings.");return}}),chrome.storage.local.get(["chatHistory"],t=>{(t.chatHistory||[]).forEach(({sender:e,text:o})=>{n(e,o)})}),m.addEventListener("click",()=>{chrome.storage.local.remove("chatHistory",()=>{a.innerHTML=""})}),h.addEventListener("click",async()=>{const t=l.value.trim();t&&(n("user",t),r("user",t),l.value="",chrome.storage.local.get(["personality"],async s=>{var o,y,p;const e=s.personality||"friendly and helpful";if(!i){n("assistant","❌ API Key not set. Go to settings."),r("assistant","❌ API Key not set. Go to settings.");return}try{const d=((p=(y=(o=(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:`You are a helpful assistant. Be ${e}.`},{role:"user",content:t}]})})).json()).choices)==null?void 0:o[0])==null?void 0:y.message)==null?void 0:p.content)||"[No response]";n("assistant",d),r("assistant",d)}catch(c){n("assistant",`⚠️ Error: ${c.message}`),r("assistant",`⚠️ Error: ${c.message}`)}}))});function n(t,s){const e=document.createElement("div");e.className=`message ${t}`,e.textContent=s,a.appendChild(e),a.scrollTop=a.scrollHeight}function r(t,s){chrome.storage.local.get(["chatHistory"],e=>{const o=e.chatHistory||[];o.push({sender:t,text:s}),chrome.storage.local.set({chatHistory:o})})}});
