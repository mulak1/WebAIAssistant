import{i as v,d as f,e as h}from"./cryptoUtils.js";let a=!1,n="";function s(t,o="green"){const r=document.getElementById("status");r.textContent=t,r.style.color=o,setTimeout(()=>r.textContent="",2500)}function l(t){t.focus();const o=document.createRange(),r=window.getSelection();o.selectNodeContents(t),o.collapse(!1),r.removeAllRanges(),r.addRange(o)}document.addEventListener("DOMContentLoaded",async()=>{await v();const t=document.getElementById("apiKey"),o=document.getElementById("pasteCatcher"),r=document.getElementById("personality"),c=document.getElementById("toggleKeyVisibility"),y=c.querySelector("svg");document.getElementById("status");const d=document.getElementById("saveBtn"),p=document.getElementById("testKeyBtn"),u=document.getElementById("clearKeyBtn");chrome.storage.local.get(["encryptedApiKey","iv","personality"],async e=>{if(e.encryptedApiKey&&e.iv)try{n=await f(e.encryptedApiKey,e.iv),t.textContent=a?n:"•".repeat(n.length)}catch{console.error("🔐 Decryption failed, clearing storage..."),chrome.storage.local.remove(["encryptedApiKey","iv"]),s("⚠️ Saved API key was invalid or corrupt. Please re-enter it.","red"),n="",t.textContent=""}e.personality&&(r.value=e.personality)}),o.addEventListener("input",()=>{a||(n+=o.value,o.value="",t.textContent="•".repeat(n.length),l(t))}),t.addEventListener("keydown",e=>{!a&&(e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==="v"?o.focus():a||(e.key==="Backspace"?n=n.slice(0,-1):e.key.length===1&&!e.metaKey&&!e.ctrlKey&&(n+=e.key),setTimeout(()=>{t.textContent="•".repeat(n.length),l(t)},0),e.preventDefault())}),t.addEventListener("input",()=>{a?n=t.textContent:(t.textContent="•".repeat(n.length),l(t))}),c.addEventListener("click",()=>{a=!a,a?(t.textContent=n,y.setAttribute("fill","#10b981")):(t.textContent="•".repeat(n.length),y.setAttribute("fill","#4f46e5")),l(t)}),d.addEventListener("click",()=>{const e=r.value,i=n.trim();if(!i){s("❌ Please enter your API key.","red");return}h(i).then(({iv:m,cipher:g})=>{chrome.storage.local.set({encryptedApiKey:g,iv:m,personality:e},()=>{s("✅ Settings saved!")})})}),u.addEventListener("click",()=>{chrome.storage.local.remove(["encryptedApiKey","iv","personality"],()=>{n="",t.textContent="",r.value="friendly and helpful",s("🗑️ API key cleared","gray")})}),p.addEventListener("click",()=>{const e=n==null?void 0:n.trim();if(!e){s("❌ Enter your API key first.","red");return}s("⏳ Testing...","#555"),fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${e}`}}).then(i=>{i.ok?s("✅ API key is valid!","green"):s(`❌ Invalid key (HTTP ${i.status})`,"red")}).catch(i=>{s(`❌ Error: ${i.message}`,"red")})})});
